---
title: "README_FINAL"
author: "Roan Minnie"
date: "21 November 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')
```
#Setup 
Loading the necessary packages
```{r}
if(!require("SentimentAnalysis")) install.packages("SentimentAnalysis") 
if(!require("future")) install.packages("future")
library(rmsfuns)
load_pkg(c("tidyverse","SentimentAnalysis","tbl2xts","ggthemes","ggplot2", "furrr", "viridisLite", "viridis", "lubridate", "zoo"))
```
Create the necessary folders
```{r}
Practical.loc.root <- file.path(getwd())
Practical.loc.subdirs <- c("data", "code", "bin")
PracLoc <- build_path(glue::glue("{Practical.loc.root}/{Practical.loc.subdirs}"))
```
Loading and cleaning data 
```{r Reading and cleaing data}
#read in data here
rawdata <- readRDS("data/all_sabinet.rds") %>% 
  tbl_df %>% 
  distinct(art_date, id, .keep_all = T)
#rename columns here, in order: Date, ID, paper and body
colnames(rawdata)[colnames(rawdata) == "art_date"] <- "PubDate"
colnames(rawdata)[colnames(rawdata) == "id"] <- "ID"
colnames(rawdata)[colnames(rawdata) == "publication"] <- "paper"
colnames(rawdata)[colnames(rawdata) == "article"] <- "Body"

#Formating of data
rawdata <-  rawdata %>% 
  mutate(PubDate = as.Date(PubDate)) %>% 
  select(PubDate, ID, paper, Body) %>% 
  arrange(PubDate) %>% 
  mutate(year_month = format(PubDate, "%Y-%m")) %>% 
  tbl_df %>% 
  distinct()
```
parallel computing
```{r Parallel computing}
#use parallel function to reduce execution time
cl <- makeClusterPSOCK(availableCores() - 1)
plan(cluster, workers = cl, gc = T)

# allow futures to export objects of size 1GB or more to nodes
options(future.globals.maxSize= 3000*1024^2)
```

#Building the uncertainty scores
```{r Uncertainty score- naive}
#start by specifying the keyword vector
key_word <- c("uncertain")
#source the function that searches for keywords
source("code/fn_keyword.R")

#apply the function to the vector defined above 
indicator_table <- tibble(key_word = key_word) %>% 
  mutate(outcome = future_map(key_word, ~.x %>% fn_keyword(.)))

#create the boolean index dataset
naive_us <- indicator_table %>% 
  pull(outcome) %>% reduce(left_join, by = c("PubDate", "year_month", "ID", "Body")) %>%
  distinct %>% 
  arrange(PubDate) 

```

```{r uncertainty score-refined}
data(DictionaryLM)
str(DictionaryLM)

ruleUncertainy <- function (dtm, d) 
{
  if (!inherits(d, "SentimentDictionaryBinary")) {
    stop("Rule does not support dictionary type")
  }
  return((rowSums(as.matrix(dtm[, which(colnames(dtm) %in% 
                                          d$uncertainty)])))/rowSums(as.matrix(dtm)))
}


sentiment <- analyzeSentiment(rawdata$Body[1],
                              rules = list("UncertaintyLM" = list(ruleSentiment, loadDictionaryLM())))

f_uncertainty <- function(body){
  analyzeSentiment(body,
                                rules = list("UncertaintyLM" = list(ruleSentiment, loadDictionaryLM()))) %>% 
    unlist
}

refine_dataset <- naive_dataset %>% 
  select(PubDate, year_month, ID, Body) %>% 
  mutate(uncertain = map_dbl(Body, ~.x %>% f_uncertainty))
```

#Building topic specific indices
The following code chunks provide the methodology to create a naive (Boolean) dataset.
The function, fn_keyword, takes as input a vector of keywords which is searched for in the articles in the dataset. It creates a column for each keyword in the vector containing a 1 or 0 depending on the outcome of the search. 
```{r Political}
#start by specifying the keyword vector
key_word <- c("econom", "policy", "ANC", "party", "political", "president", "election","vote", "government", "parliament", "shuffle", "cabinet", "poll", "downgrade", "junk", "legislation", "rating", "credit")
#source the function that searches for keywords
source("code/fn_keyword.R")

#apply the function to the vector defined above 
indicator_table <- tibble(key_word = key_word) %>% 
  mutate(outcome = future_map(key_word, ~.x %>% fn_keyword(.)))

#create the boolean index dataset
political_dataset <- indicator_table %>% 
  pull(outcome) %>% reduce(left_join, by = c("PubDate", "year_month", "ID", "Body")) %>%
  distinct %>% 
  arrange(PubDate) 
write_rds(political_dataset, "data/political_full.rds")

political_small <- political_dataset %>% select(-ID, -Body)
write_rds(political_small, "data/political.rds")


```


```{r fiscal}
#start by specifying the keyword vector
key_word <- c("econom", "policy", "fiscal","parliament","legislation", "minister", "budget", "financ", "speech", "government", "bill", "tax", "VAT", "downgrade", "debt", "sovereign", "rating", "credit","expenditure", "spending")
#source the function that searches for keywords
source("code/fn_keyword.R")

#apply the function to the vector defined above 
indicator_table <- tibble(key_word = key_word) %>% 
  mutate(outcome = future_map(key_word, ~.x %>% fn_keyword(.)))

#create the boolean index dataset
fiscal_dataset <- indicator_table %>% 
  pull(outcome) %>% reduce(left_join, by = c("PubDate", "year_month", "ID", "Body")) %>%
  distinct %>% 
  arrange(PubDate) 

write_rds(fiscal_dataset, "data/fiscal_full.rds")

fiscal_small <- fiscal_dataset %>% select(-ID, -Body)
write_rds(fiscal_small, "data/fiscal.rds")

```

```{r monetary}
#start by specifying the keyword vector
key_word <- c("econom", "policy", "price", "inflation", "monetary", "committee", "oil", "shock", "SARB", "reserve bank", "interest", "rate", "repo", "review", "hike", "increase", "decrease", "lower")
#source the function that searches for keywords
source("code/fn_keyword.R")

#apply the function to the vector defined above 
indicator_table <- tibble(key_word = key_word) %>% 
  mutate(outcome = future_map(key_word, ~.x %>% fn_keyword(.)))

#create the boolean index dataset
monetary_dataset <- indicator_table %>% 
  pull(outcome) %>% reduce(left_join, by = c("PubDate", "year_month", "ID", "Body")) %>%
  distinct %>% 
  arrange(PubDate) 

write_rds(monetary_dataset, "data/monetary_full.rds")

monetary_small <- monetary_dataset %>% select(-ID, -Body)
write_rds(monetary_small, "data/monetary.rds")
```

```{r financial}
#start by specifying the keyword vector
key_word <- c("econom", "policy", "debt", "sovereign", "rating", "credit","stock", "bond", "invest", "rate", "FDI", "bank")
#source the function that searches for keywords
source("code/fn_keyword.R")

#apply the function to the vector defined above 
indicator_table <- tibble(key_word = key_word) %>% 
  mutate(outcome = future_map(key_word, ~.x %>% fn_keyword(.)))

#create the boolean index dataset
financial_dataset <- indicator_table %>% 
  pull(outcome) %>% reduce(left_join, by = c("PubDate", "year_month", "ID", "Body")) %>%
  distinct %>% 
  arrange(PubDate)

write_rds(financial_dataset, "data/financial_full.rds")

financial_small <- financial_dataset %>% select(-ID, -Body)
write_rds(financial_small, "data/financial.rds")
```

#Topic specific uncertainty indices
##constructing complete datasets
```{r}
political <- readRDS("data/political.rds") 
political_us <- political %>% 
  mutate(naive_us = naive_raw$uncertain) %>% 
  mutate(refine_us= (refine_raw$uncertain)*(-1))

fiscal <- readRDS("data/fiscal.rds") 
fiscal_us <- fiscal %>% 
  mutate(naive_us = naive_raw$uncertain) %>% 
  mutate(refine_us= (refine_raw$uncertain)*(-1))

monetary <- readRDS("data/monetary.rds") 
monetary_us <- monetary %>% 
  mutate(naive_us = naive_raw$uncertain) %>% 
  mutate(refine_us= (refine_raw$uncertain)*(-1))

```

##Political
```{r}
criteria <- c("econom", "policy", "ANC", "party", "political", "president", "election","vote", "government", "parliament", "shuffle", "cabinet", "poll", "downgrade", "junk", "legislation", "rating", "credit")

#constructing the naive index per keyword in the political category
fn_naive<- function(criteria){
political_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
  arrange(PubDate) %>% 
  group_by(PubDate) %>%
  add_tally() %>% ungroup() %>% 
  select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, naive_us)%>% 
  group_by(PubDate) %>% 
  mutate(freq = mean(naive_us)) %>% ungroup() %>% 
  select(PubDate, year_month, freq) %>%
  unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

political_naive <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_naive(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(political_naive) <- c("year_month","econom", "policy", "ANC", "party", "political", "president", "election","vote", "government", "parliament", "shuffle", "cabinet", "poll", "downgrade", "junk", "legislation", "rating", "credit")

write_rds(x = political_naive, "data/political_naive.rds")


#constructing the refined index per keyword in the political category

fn_refine<- function(criteria){
political_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
    arrange(PubDate) %>% 
    group_by(PubDate) %>%
    add_tally() %>% ungroup() %>% 
    select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, refine_us)%>%
    group_by(PubDate) %>% 
    mutate(freq = mean(refine_us)) %>%  ungroup() %>%
    select(PubDate, year_month, freq) %>%
    unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

political_refine <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_refine(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(political_refine) <- c("year_month","econom", "policy", "ANC", "party", "political", "president", "election","vote", "government", "parliament", "shuffle", "cabinet", "poll", "downgrade", "junk", "legislation", "rating", "credit")

write_rds(x = political_refine, "data/political_refine.rds")

```


##Fiscal
```{r}
criteria <- c("econom", "policy", "fiscal","parliament","legislation", "minister", "budget", "financ", "speech", "government", "bill", "tax", "VAT", "downgrade", "debt", "sovereign", "rating", "credit","expenditure", "spending")


#constructing the naive index per keyword in the fiscal category
fn_naive<- function(criteria){
fiscal_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
  arrange(PubDate) %>% 
  group_by(PubDate) %>%
  add_tally() %>% ungroup() %>% 
  select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, naive_us)%>% 
  group_by(PubDate) %>% 
  mutate(freq = mean(naive_us)) %>%  ungroup() %>% 
  select(PubDate, year_month, freq) %>%
  unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

fiscal_naive <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_naive(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(fiscal_naive) <- c("year_month","econom", "policy", "fiscal","parliament","legislation", "minister", "budget", "financ", "speech", "government", "bill", "tax", "VAT", "downgrade", "debt", "sovereign", "rating", "credit","expenditure", "spending")

write_rds(x = fiscal_naive, "data/fiscal_naive.rds")


#constructing the refined index per keyword in the fiscal category

fn_refine<- function(criteria){
fiscal_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
    arrange(PubDate) %>% 
    group_by(PubDate) %>%
    add_tally() %>% ungroup() %>% 
    select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, refine_us)%>%
    group_by(PubDate) %>% 
    mutate(freq = mean(refine_us)) %>% ungroup() %>%
    select(PubDate, year_month, freq) %>%
    unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

fiscal_refine <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_refine(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(fiscal_refine) <- c("year_month","econom", "policy", "fiscal","parliament","legislation", "minister", "budget", "financ", "speech", "government", "bill", "tax", "VAT", "downgrade", "debt", "sovereign", "rating", "credit","expenditure", "spending")

write_rds(x = fiscal_refine, "data/fiscal_refine.rds")
```

##Monetary
```{r}
criteria <- c("econom", "policy", "price", "inflation", "monetary", "committee", "oil", "shock", "SARB", "interest", "rate", "repo", "review", "hike", "increase", "decrease", "lower")

#constructing the naive index per keyword in the monetary category
fn_naive<- function(criteria){
monetary_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
  arrange(PubDate) %>% 
  group_by(PubDate) %>%
  add_tally() %>% ungroup() %>% 
  select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, naive_us)%>% 
  group_by(PubDate) %>% 
  mutate(freq = mean(naive_us)) %>% ungroup() %>% 
  select(PubDate, year_month, freq) %>%
  unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

monetary_naive <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_naive(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(monetary_naive) <- c("year_month","econom", "policy", "price", "inflation", "monetary", "committee", "oil", "shock", "SARB", "interest", "rate", "repo", "review", "hike", "increase", "decrease", "lower")

write_rds(x = monetary_naive, "data/monetary_naive.rds")


#constructing the refined index per keyword in the monetary category

fn_refine<- function(criteria){
monetary_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
    arrange(PubDate) %>% 
    group_by(PubDate) %>%
    add_tally() %>% ungroup() %>% 
    select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, refine_us)%>%
    group_by(PubDate) %>% 
    mutate(freq = mean(refine_us)) %>% ungroup() %>%
    select(PubDate, year_month, freq) %>%
    unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

monetary_refine <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_refine(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(monetary_refine) <- c("year_month","econom", "policy", "price", "inflation", "monetary", "committee", "oil", "shock", "SARB", "interest", "rate", "repo", "review", "hike", "increase", "decrease", "lower")

write_rds(x = monetary_refine, "data/monetary_refine.rds")
```

##Finance
```{r}
criteria <- c("econom", "policy", "debt", "sovereign", "rating", "credit","stock", "bond", "invest", "rate", "FDI", "bank", "financ", "market", "JSE", "exchange", "rand")

financial_us <- financial %>% 
  mutate(financ = naive_raw$financ) %>% 
  mutate(market = naive_raw$market) %>% 
  mutate(JSE = naive_raw$JSE) %>% 
  mutate(exchange = naive_raw$exchange) %>% 
  mutate(rand = naive_raw$rand) %>% 
  mutate(naive_us=naive_raw$uncertain) %>% 
  mutate(refine_us= (refine_raw$uncertain)*(-1))

#constructing the naive index per keyword in the monetary category
fn_naive<- function(criteria){
financial_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
  arrange(PubDate) %>% 
  group_by(PubDate) %>%
  add_tally() %>% ungroup() %>% 
  select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, naive_us)%>% 
  group_by(PubDate) %>% 
  mutate(freq = mean(naive_us)) %>% ungroup() %>% 
  select(PubDate, year_month, freq) %>%
  unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

financial_naive <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_naive(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(financial_naive) <- c("year_month", "econom", "policy", "debt", "sovereign", "rating", "credit","stock", "bond", "invest", "rate", "FDI", "bank", "financ", "market", "JSE", "exchange", "rand")
write_rds(x = financial_naive, "data/financial_naive.rds")


#constructing the refined index per keyword in the monetary category

fn_refine<- function(criteria){
financial_us %>% 
  filter(PubDate >="2004-01-01") %>% 
  filter(!!rlang::parse_quosure(criteria)=="1") %>% 
    arrange(PubDate) %>% 
    group_by(PubDate) %>%
    add_tally() %>% ungroup() %>% 
    select(PubDate, year_month, !!rlang::parse_quosure(criteria), n, refine_us)%>%
    group_by(PubDate) %>% 
    mutate(freq = mean(refine_us)) %>% ungroup() %>%
    select(PubDate, year_month, freq) %>%
    unique() %>% 
  group_by(year_month) %>% 
  summarise(uncertain = mean(freq, na.rm = T)) %>% 
  mutate(uncertain = scale(uncertain)) %>% ungroup() %>% 
  select(year_month, uncertain) %>% 
  unique()
}

financial_refine <- tibble(criteria = criteria) %>% 
  mutate(outcome = future_map(criteria, ~.x %>% fn_refine(.))) %>% 
  pull(outcome) %>% reduce(left_join, by = "year_month") %>%
  distinct 

colnames(financial_refine) <- c("year_month", "econom", "policy", "debt", "sovereign", "rating", "credit","stock", "bond", "invest", "rate", "FDI", "bank", "financ", "market", "JSE", "exchange", "rand")

write_rds(x = financial_refine, "data/financial_refine.rds")
```



#Composite indices
##Political
```{r}
political_naive <- readRDS("data/political_naive.rds") 
#Naive
tmp <- political_naive%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#69b3a2", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - naive Political index") +
    facet_wrap(~type)

ggsave("bin/pol_key_naive.jpeg")


political_comp <- political_naive %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

political_comp_index <- political_comp$ind$coord[,1]

political_naive <- political_naive %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = political_comp_index) 

write_rds(political_naive, "data/pol_naive_pe.rds")

political_naive %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#69b3a2", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Political uncertainty in South Africa - naive index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/pol_comp_naive.jpeg")


#Refine
political_refine <- readRDS("data/political_refine.rds")
tmp <- political_refine%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#453781FF", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - refined Political index") +
    facet_wrap(~type)

ggsave("bin/pol_key_refine.jpeg")


political_comp <- political_refine %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

political_comp_index <- political_comp$ind$coord[,1]

political_refine<- political_refine %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = political_comp_index)

write_rds(political_refine, "data/pol_refine_pe.rds")

political_refine %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#453781FF", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Political uncertainty in South Africa - refined index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/pol_comp_refine.jpeg")
```



##Fiscal
```{r}
fiscal_naive <- readRDS("data/fiscal_naive.rds") 
#Naive
tmp <- fiscal_naive%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#6b4596ff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - naive Fiscal Policy index") +
    facet_wrap(~type)

ggsave("bin/fiscal_key_naive.jpeg")


fiscal_comp <- fiscal_naive %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

fiscal_comp_index <- fiscal_comp$ind$coord[,1]

fiscal_naive <- fiscal_naive %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = fiscal_comp_index) 

write_rds(fiscal_naive, "data/fis_naive_pe.rds")

fiscal_naive %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#6b4596ff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Fiscal Policy uncertainty in South Africa - naive index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/fiscal_comp_naive.jpeg")


#Refine
fiscal_refine <- readRDS("data/fiscal_refine.rds")
tmp <- fiscal_refine%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#eb8055ff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - refined Fiscal Policy index") +
    facet_wrap(~type)

ggsave("bin/fiscal_key_refine.jpeg")


fiscal_comp <- fiscal_refine %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

fiscal_comp_index <- fiscal_comp$ind$coord[,1]

fiscal_refine<- fiscal_refine %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = fiscal_comp_index) 

write_rds(fiscal_refine, "data/fis_refine_pe.rds")

fiscal_refine %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#eb8055ff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Fiscal Policy uncertainty in South Africa - refined index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/fiscal_comp_refine.jpeg")
```



##Monetary
```{r}
monetary_naive <- readRDS("data/monetary_naive.rds") 
#Naive
tmp <- monetary_naive%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#31668dff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - naive Monetary Policy index") +
    facet_wrap(~type)

ggsave("bin/monetary_key_naive.jpeg")


monetary_comp <- monetary_naive %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

monetary_comp_index <- monetary_comp$ind$coord[,1]

monetary_naive <- monetary_naive %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = monetary_comp_index) 

write_rds(monetary_naive, "data/mon_naive_pe.rds")

monetary_naive %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#31668dff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Monetary Policy uncertainty in South Africa - naive index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/monetary_comp_naive.jpeg")


#Refine
monetary_refine <- readRDS("data/monetary_refine.rds")
tmp <- monetary_refine%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#6dcc58ff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - refined Monetary Policy index") +
    facet_wrap(~type)

ggsave("bin/monetary_key_refine.jpeg")


monetary_comp <- monetary_refine %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

monetary_comp_index <- monetary_comp$ind$coord[,1]

monetary_refine<- monetary_refine %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = monetary_comp_index) 

write_rds(monetary_refine, "data/mon_refine_pe.rds")

monetary_refine %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#6dcc58ff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Monetary Policy uncertainty in South Africa - refined index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/monetary_comp_refine.jpeg")
```
##Fiancial
```{r}
financial_naive <- readRDS("data/financial_naive.rds") 
#Naive
tmp <- financial_naive%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#472775ff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - naive F inancial index") +
    facet_wrap(~type)

ggsave("bin/financial_key_naive.jpeg")


financial_comp <- financial_naive %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

financial_comp_index <- financial_comp$ind$coord[,1]

financial_naive <- financial_naive %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = financial_comp_index) 

write_rds(financial_naive, "data/fin_naive_pe.rds")

financial_naive %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#472775ff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Financial uncertainty in South Africa - naive index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/financial_comp_naive.jpeg")


#Refine
financial_refine <- readRDS("data/financial_refine.rds")
tmp <- financial_refine%>% 
  gather(., type, value, -year_month) %>% 
  mutate(type2 = type) 
  

tmp %>%
  ggplot( aes(x=year_month, y=value, group = 1)) +
    geom_line( data=tmp %>% dplyr::select(-type), aes(group=type2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=type), color="#b0dd31ff", size=1 )+
    scale_color_viridis(discrete = TRUE) +
    scale_x_discrete(breaks = c("2004-01","2005-01","2006-01","2007-01","2008-01","2009-01","2010-01","2011-01","2012-01","2013-01","2014-01","2015-01","2016-01", "2017-01"))+
    theme_base() +
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90)
    ) +
    ggtitle("Evolution of uncertainty by keyword - refined Financial index") +
    facet_wrap(~type)

ggsave("bin/financial_key_refine.jpeg")


financial_comp <- financial_refine %>% 
  .[complete.cases(.),] %>% 
  select(-year_month) %>% 
  FactoMineR::PCA()

financial_comp_index <- financial_comp$ind$coord[,1]

financial_refine<- financial_refine %>% 
  .[complete.cases(.),] %>% 
  mutate(composite = financial_comp_index) 

write_rds(financial_refine, "data/fin_refine_pe.rds")

financial_refine %>%
  gather(., type, value, -year_month) %>%
  mutate( highlight=ifelse(type=="composite", "composite", "Other")) %>%
  ggplot( aes(x=year_month, y=value, group=type, color=highlight, size=highlight)) +
    geom_line() +
    scale_color_manual(values = c("#b0dd31ff", "grey")) +
    scale_size_manual(values=c(1.5,0.2)) +
    theme(legend.position="none") +
    ggtitle("Evolution of Financial uncertainty in South Africa - refined index") +
    theme_base()+
    theme(
      legend.position="none",
      plot.title = element_text(size=14),
      axis.text.x = element_text(angle = 90)
)

ggsave("bin/financial_comp_refine.jpeg")
```

#Postestimation analysis
```{r}
pol_naive_pe <- readRDS("data/pol_naive_pe.rds")
pol_refine_pe <- readRDS("data/pol_refine_pe.rds")
fis_naive_pe <- readRDS("data/fis_naive_pe.rds")
fis_refine_pe <- readRDS("data/fis_refine_pe.rds")
mon_naive_pe <- readRDS("data/mon_naive_pe.rds")
mon_refine_pe <- readRDS("data/mon_refine_pe.rds")
fin_naive_pe <- readRDS("data/fin_naive_pe.rds")
fin_refine_pe <- readRDS("data/fin_refine_pe.rds")
```

```{r Appendix graphs}
political_comps <-  pol_naive_pe %>% 
  select(year_month) %>%
  mutate(naive = pol_naive_pe$composite) %>% 
  mutate(refined= pol_refine_pe$composite) %>% 
  gather(., index, value, -year_month)

write_rds(political_comps, "data/political_comps.rds")


rectangle1 <- data.frame(xmin = "2015-09",
                        xmax = "2017-09",
                        ymin = -Inf, ymax = Inf)

rectangle2 <- data.frame(xmin = "2007-11",
                        xmax = "2010-01",
                        ymin = -Inf, ymax = Inf)

political_comps %>%
  ggplot(aes(x=year_month, y=value, group=index, color = index)) +
  geom_rect(data = rectangle1, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#453781FF" , alpha = 0.2,inherit.aes = FALSE )+
  geom_rect(data = rectangle2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#453781FF" , alpha = 0.2,inherit.aes = FALSE )+
  geom_line(aes(size = index))+
  scale_size_manual(values=c(0.2, 1.5)) +
  scale_color_manual(values = c("grey","#453781FF"))+
  theme(legend.position="none") +
  ggtitle("Naive- and refined political uncertainty index") +
  theme_base()+
  theme(
    legend.position="none",
    plot.title = element_text(size=14),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_x_discrete(breaks = c("2007-11", "2010-01","2015-09", "2017-09"))

ggsave("bin/pol_comps.jpeg")
  
fiscal_comps <-  fis_naive_pe %>% 
  select(year_month) %>%
  mutate(naive = fis_naive_pe$composite) %>% 
  mutate(refined= fis_refine_pe$composite) %>% 
  gather(., index, value, -year_month)

write_rds(fiscal_comps, "data/fiscal_comps.rds")


fiscal_comps %>%
  ggplot(aes(x=year_month, y=value, group=index, color = index)) +
  geom_rect(data = rectangle1, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#6b4596ff" , alpha = 0.2,inherit.aes = FALSE )+
  geom_rect(data = rectangle2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#6b4596ff" , alpha = 0.2,inherit.aes = FALSE )+
  geom_line(aes(size = index))+
  scale_size_manual(values=c(0.2, 1.5)) +
  scale_color_manual(values = c("grey","#6b4596ff"))+
  theme(legend.position="none") +
  ggtitle("Naive- and refined fiscal policy uncertainty index") +
  theme_base()+
  theme(
    legend.position="none",
    plot.title = element_text(size=14),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_x_discrete(breaks = c("2007-11", "2010-01","2015-09", "2017-09"))

ggsave("bin/fiscal_comps.jpeg")

monetary_comps <-  mon_naive_pe %>% 
  select(year_month) %>%
  mutate(naive = mon_naive_pe$composite) %>% 
  mutate(refined= mon_refine_pe$composite) %>% 
  gather(., index, value, -year_month)

write_rds(monetary_comps, "data/monetary_comps.rds")


monetary_comps %>%
  ggplot(aes(x=year_month, y=value, group=index, color = index)) +
  geom_rect(data = rectangle1, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#31668dff" , alpha = 0.2,inherit.aes = FALSE )+
  geom_rect(data = rectangle2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#31668dff" , alpha = 0.2,inherit.aes = FALSE )+
  geom_line(aes(size = index))+
  scale_size_manual(values=c(0.2, 1.5)) +
  scale_color_manual(values = c("grey","#31668dff"))+
  theme(legend.position="none") +
  ggtitle("Naive- and refined monetary policy uncertainty index") +
  theme_base()+
  theme(
    legend.position="none",
    plot.title = element_text(size=14),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_x_discrete(breaks = c("2007-11", "2010-01","2015-09", "2017-09"))

ggsave("bin/monetary_comps.jpeg")

financial_comps <-  fin_naive_pe %>% 
  select(year_month) %>%
  mutate(naive = fin_naive_pe$composite) %>% 
  mutate(refined= fin_refine_pe$composite) %>% 
  gather(., index, value, -year_month)

write_rds(financial_comps, "data/financial_comps.rds")


financial_comps %>%
  ggplot(aes(x=year_month, y=value, group=index, color = index)) +
  geom_rect(data = rectangle1, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#6dcc58ff", alpha = 0.2,inherit.aes = FALSE )+
  geom_rect(data = rectangle2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
              fill ="#6dcc58ff" , alpha = 0.2,inherit.aes = FALSE )+
  geom_line(aes(size = index))+
  scale_size_manual(values=c(0.2, 1.5)) +
  scale_color_manual(values = c("grey","#6dcc58ff"))+
  theme(legend.position="none") +
  ggtitle("Naive- and refined fiancial uncertainty index") +
  theme_base()+
  theme(
    legend.position="none",
    plot.title = element_text(size=14),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_x_discrete(breaks = c("2007-11", "2010-01","2015-09", "2017-09"))

ggsave("bin/financial_comps.jpeg")

```


```{r}
rawdata <- refine_raw %>% 
  select(year_month, PubDate) %>% 
  mutate(body = all_sabinet$article) %>% 
  mutate(refine = (refine_raw$uncertain)*(-1)) %>% 
  filter(year_month>="2004-01")

write_rds(rawdata, "data/postestimation.rds")

first_cohort <- rawdata %>% 
  filter(year_month<="2006-12" & year_month>="2004-06") %>% 
  group_by(PubDate) %>%
  mutate(us = mean(refine)) %>% ungroup() 

second_cohort <- rawdata %>% 
  filter(year_month<="2009-12" & year_month>="2007-12") %>% 
  group_by(PubDate) %>%
  mutate(us = mean(refine)) %>% ungroup() 

third_cohort <- rawdata %>% 
  filter(year_month<="2014-09" & year_month>="2013-10") %>% 
  group_by(PubDate) %>%
  mutate(us = mean(refine)) %>% ungroup() 

fourth_cohort <- rawdata %>% 
  filter(year_month<="2017-07" & year_month>="2015-09") %>% 
  group_by(PubDate) %>%
  mutate(us = mean(refine)) %>% ungroup() 


temp<- fourth_cohort %>% filter(year_month=="2015-12") %>% select(year_month, PubDate, us) %>% unique() %>% arrange(us, decreasing=TRUE) %>% head(., n = 5) %>% arrange(PubDate)
```

```{r}
parallel::stopCluster(cl)
```

